<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planilha de Hierarquia — RP</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class',theme:{extend:{}}}</script>
<style>
  html,body{height:100%} body{background:#020617}
  .grid-wrap{overflow:auto; max-height:calc(100vh - 210px);}
  .sheet{display:grid; grid-auto-rows:minmax(36px,auto); position:relative;}
  .cell{border-top:1px solid rgba(255,255,255,.06); padding:.5rem .75rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .cell[contenteditable="true"]:focus{outline:2px solid rgba(245,158,11,.5); border-radius:.5rem; background:rgba(255,255,255,.04)}
  .row:hover .cell{background:rgba(255,255,255,.02);}

  /* cabeçalho continua fixo */
  .head{position:sticky; top:0; z-index:5; background:rgba(2,6,23,.9); backdrop-filter:blur(6px); border-bottom:1px solid rgba(255,255,255,.08); font-weight:600;}

  /* chips flag */
  .flag{display:inline-flex; align-items:center; gap:.5rem; padding:.15rem .55rem; border-radius:999px; font-size:.75rem; font-weight:600;}
  .flag.true{background:rgba(34,197,94,.15); color:rgb(134,239,172); border:1px solid rgba(34,197,94,.3)}
  .flag.false{background:rgba(239,68,68,.15); color:rgb(252,165,165); border:1px solid rgba(239,68,68,.3)}
  .flag .dot{width:.5rem; height:.5rem; border-radius:999px;}
  .flag.true .dot{background:rgb(34,197,94)}
  .flag.false .dot{background:rgb(239,68,68)}

  .section{grid-column:1 / -1; font-weight:700; text-transform:uppercase; color:rgb(253,230,138);
           background:rgba(120,53,15,.15); border-top:1px solid rgba(253,230,138,.25); padding:.4rem .75rem}
</style>
</head>
<body class="dark text-slate-100">
<div class="max-w-7xl mx-auto px-4 py-6">
  <header class="mb-4 flex items-center gap-3">
    <div class="h-10 w-10 rounded-lg grid place-items-center font-black border border-amber-500/40 bg-slate-900/60">R</div>
    <div>
      <h1 class="text-xl font-bold">Planilha de Hierarquia — RP</h1>
      <p class="text-sm text-slate-400">Edição direta, sem colunas fixas</p>
    </div>
    <div class="ml-auto toolbar flex flex-wrap items-center gap-2">
      <button id="addRow" class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-xs">+ Linha</button>
      <button id="addSection" class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-xs">+ Seção</button>
      <button id="delLast" class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-xs">– Remover última</button>
      <button id="saveJson" class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-xs">Baixar JSON</button>
      <label class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-xs cursor-pointer">Carregar JSON
        <input id="loadJson" type="file" accept="application/json" class="hidden">
      </label>
      <label class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-xs cursor-pointer">Importar CSV
        <input id="loadCsv" type="file" accept=".csv,text/csv" class="hidden">
      </label>
      <button id="saveCsv" class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-xs">Baixar CSV</button>
    </div>
  </header>

  <section class="mb-3 grid md:grid-cols-3 gap-3">
    <div class="md:col-span-2">
      <label class="text-sm text-slate-400">Buscar</label>
      <input id="q" class="w-full mt-1 px-3 py-2 rounded-lg border border-white/10 bg-slate-900/60" placeholder="nome, matrícula, patente, função..." />
    </div>
    <div>
      <label class="text-sm text-slate-400">Densidade</label>
      <select id="density" class="w-full mt-1 px-3 py-2 rounded-lg border border-white/10 bg-slate-900/60">
        <option value="36">Compacta</option>
        <option value="44" selected>Normal</option>
        <option value="56">Conforto</option>
      </select>
    </div>
  </section>

  <div id="status" class="mb-3 text-sm text-slate-400">Pronto.</div>

  <div id="gridWrap" class="grid-wrap rounded-2xl border border-white/10 bg-slate-900/40 shadow-xl">
    <div id="sheet" class="sheet"></div>
  </div>
</div>

<script>
/* ===== SCHEMA ===== */
const COLUMNS = [
  { key:"matricula", label:"Matrícula", width:"10rem", type:"text" },
  { key:"nome",      label:"Nome",      width:"12rem", type:"text" },
  { key:"guerra",    label:"Nome de Guerra", width:"12rem", type:"text" },
  { key:"patente",   label:"Patente",   width:"10rem", type:"select", options:[
      "TEN.CEL PM","MAJ PM","CAP PM","1º TEN PM","2º TEN PM","ASP OF PM",
      "SUBTEN PM","1º SGT PM","2º SGT PM","3º SGT PM","CB PM","SD PM","ALUNO"
    ]
  },
  { key:"funcao",    label:"Função",    width:"26rem", type:"text", wrap:true },
  { key:"lp25",      label:"LP 25",     width:"7rem",  type:"flag", trueLabel:"VERDADEIRO", falseLabel:"FALSO" },
  { key:"cdc",       label:"CDC",       width:"7rem",  type:"flag", trueLabel:"VERDADEIRO", falseLabel:"FALSO" },
  { key:"cpe",       label:"CPE",       width:"7rem",  type:"flag", trueLabel:"VERDADEIRO", falseLabel:"FALSO" },
  { key:"data_entrada", label:"Data de Entrada", width:"10rem", type:"date" },
  { key:"obs",          label:"Observações | Padrinhos", width:"18rem", type:"text", wrap:true },
];

/* ===== DADOS EXEMPLO ===== */
const INITIAL_ROWS = [
  { type:"section", title:"COMANDO AGUIAR" },
  { matricula:"2410202230", nome:"Matheus Bezerra", guerra:"Bezerra", patente:"TEN.CEL PM", funcao:"COMANDANTE AGUIAR / COMANDANTE SINDICÂNCIA / COMANDANTE CCOMSOC", lp25:true, cdc:true, cpe:true, data_entrada:"2022-03-01", obs:"-" },
  { matricula:"1042022255", nome:"Davi Costa", guerra:"Rivotril", patente:"MAJ PM", funcao:"SUBCOMANDANTE AGUIAR / SUPERVISOR SINDICÂNCIAS / SUPERVISOR CCOMSOC", lp25:false, cdc:false, cpe:true, data_entrada:"2022-04-01", obs:"-" },
  { type:"section", title:"OFICIAIS INTERMEDIÁRIOS" },
  { matricula:"1072023259", nome:"Saléh Matias", guerra:"Tranca Rua", patente:"CAP PM", funcao:"COMANDANTE 1ª CIA / COMANDO DECIC / COMANDANTE P1 / COMANDANTE P4", lp25:false, cdc:true, cpe:true, data_entrada:"2023-07-01", obs:"-" },
];

/* ===== STATE ===== */
let ROWS = loadFromLocal() || INITIAL_ROWS.slice();
const state = { q:"" };

/* ===== RENDER ===== */
const sheetEl = document.getElementById('sheet');

function computeCols(){
  sheetEl.style.gridTemplateColumns = COLUMNS.map(c=>c.width||"12rem").join(' ');
}
function renderHeader(){
  const frag=document.createDocumentFragment();
  COLUMNS.forEach(col=>{
    const h=document.createElement('div');
    h.className="cell head";
    h.textContent=col.label;
    frag.appendChild(h);
  });
  sheetEl.appendChild(frag);
}

function flagChip(value, col){
  const on=!!value;
  const div=document.createElement('div');
  div.className=`flag ${on?'true':'false'}`;
  div.innerHTML=`<span class="dot"></span>${on?(col.trueLabel||'SIM'):(col.falseLabel||'NÃO')}`;
  return div;
}

function renderRow(row, idx){
  if(row.type==="section"){
    const s=document.createElement('div');
    s.className="section";
    s.textContent=row.title||"(Seção)";
    sheetEl.appendChild(s);
    return;
  }
  COLUMNS.forEach(col=>{
    const cell=document.createElement('div');
    cell.className="cell row";
    cell.dataset.row=idx; cell.dataset.key=col.key;

    const val=row[col.key]??"";
    if(col.type==="flag"){
      const chip=flagChip(val,col);
      chip.style.cursor="pointer";
      chip.addEventListener('click',()=>{ row[col.key]=!row[col.key]; persist(); refresh(); });
      cell.appendChild(chip);
    } else if(col.type==="select"){
      const select=document.createElement('select');
      select.className="bg-transparent border border-white/10 rounded-md px-2 py-1 text-sm w-full";
      (col.options||[]).forEach(opt=>{
        const o=document.createElement('option'); o.textContent=opt; o.value=opt; if(opt===val) o.selected=true; select.appendChild(o);
      });
      select.addEventListener('change',e=>{ row[col.key]=e.target.value; persist(); });
      cell.appendChild(select);
    } else if(col.type==="date"){
      const input=document.createElement('input'); input.type="date";
      input.className="bg-transparent border border-white/10 rounded-md px-2 py-1 text-sm w-full";
      if(val) input.value=String(val).slice(0,10);
      input.addEventListener('change',e=>{ row[col.key]=e.target.value; persist(); });
      cell.appendChild(input);
    } else {
      const editable=document.createElement('div');
      editable.contentEditable="true";
      editable.className="w-full";
      editable.textContent=val;
      editable.addEventListener('blur',()=>{ row[col.key]=editable.textContent.trim(); persist(); });
      cell.appendChild(editable);
    }
    sheetEl.appendChild(cell);
  });
}

function renderBody(){
  sheetEl.innerHTML="";
  renderHeader();
  const q=normalize(state.q);
  const rows=ROWS.filter(r=>{
    if(r.type==="section") return true;
    if(!q) return true;
    return COLUMNS.some(col=>normalize(r[col.key]).includes(q));
  });
  rows.forEach((row,i)=>renderRow(row,i));
}

function refresh(){ computeCols(); renderBody(); }
computeCols(); renderBody();

/* ===== UI ===== */
document.getElementById('q').addEventListener('input',e=>{ state.q=e.target.value; renderBody(); });
document.getElementById('density').addEventListener('change',e=>{
  const h=parseInt(e.target.value,10);
  document.querySelectorAll('.cell').forEach(el=>el.style.minHeight=h+'px');
});

/* ===== CONTROLES ===== */
document.getElementById('addRow').addEventListener('click',()=>{ ROWS.push(Object.fromEntries(COLUMNS.map(c=>[c.key,""]))); persist(); refresh(); });
document.getElementById('addSection').addEventListener('click',()=>{ const title=prompt("Título da seção:","NOVA SEÇÃO"); if(title){ ROWS.push({type:"section",title}); persist(); refresh(); }});
document.getElementById('delLast').addEventListener('click',()=>{ ROWS.pop(); persist(); refresh(); });

document.getElementById('saveJson').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(ROWS,null,2)],{type:'application/json;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='hierarquia.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('loadJson').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{ ROWS=JSON.parse(r.result); persist(); refresh(); }catch{ alert('JSON inválido'); } };
  r.readAsText(f);
});

/* CSV */
function parseCSV(txt){const rows=[];let i=0,f='',row=[],q=false;while(i<txt.length){const c=txt[i];if(q){if(c=='"'){if(txt[i+1]=='"'){f+='"';i++;}else q=false;}else f+=c;}else{if(c=='"')q=true;else if(c==','){row.push(f);f='';}else if(c=='\n'||c=='\r'){if(f.length||row.length){row.push(f);rows.push(row);row=[];f='';}if(c=='\r'&&txt[i+1]=='\n')i++;}else f+=c;}i++;}if(f.length||row.length){row.push(f);rows.push(row);}return rows;}
document.getElementById('loadCsv').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{
    const data=parseCSV(r.result); const [hdr,...lines]=data;
    const map=hdr.map(h=>{const n=normalize(h); return COLUMNS.find(c=>normalize(c.label)===n||normalize(c.key)===n)?.key||null;});
    const rows=[];
    lines.forEach(cells=>{
      if(cells.every(c=>!String(c||"").trim())) return;
      const obj={}; map.forEach((k,i)=>{ if(!k) return; const col=COLUMNS.find(c=>c.key===k); let v=cells[i];
        if(col?.type==='flag'){const nv=normalize(v); obj[k]=(nv==='true'||nv==='verdadeiro'||nv==='sim'||nv==='ok');}
        else if(col?.type==='date'){obj[k]=new Date(v).toISOString().slice(0,10);}
        else {obj[k]=v;}
      }); rows.push(obj);
    });
    ROWS=rows; persist(); refresh();
  }; r.readAsText(f);
});
document.getElementById('saveCsv').addEventListener('click',()=>{
  const rows=[]; rows.push(COLUMNS.map(c=>c.label));
  ROWS.forEach(r=>{ if(r.type==='section') return; const arr=COLUMNS.map(col=>{ let v=r[col.key]??""; if(col.type==='flag') v=(v?(col.trueLabel||'SIM'):(col.falseLabel||'NÃO')); return v; }); rows.push(arr); });
  const esc=s=>/[",\n]/.test(String(s))?`"${String(s).replace(/"/g,'""')}"`:String(s);
  const csv=rows.map(r=>r.map(esc).join(",")).join("\n");
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"})); a.download="hierarquia.csv"; a.click(); URL.revokeObjectURL(a.href);
});

/* utils */
function normalize(s){return String(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,'').toLowerCase();}
function persist(){ localStorage.setItem('rp.hierarquia.rows', JSON.stringify(ROWS)); }
function loadFromLocal(){ try{ return JSON.parse(localStorage.getItem('rp.hierarquia.rows')||'null'); }catch{return null;} }
</script>
</body>
</html>
