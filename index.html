<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carteirinhas do Batalhão — RP</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class',theme:{extend:{}}}</script>
<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  html,body{height:100%} body{background:#020617}
  .panel{display:grid; grid-template-columns: 340px 1fr; gap:1rem;}
  .scroll{overflow:auto}
  .card{background:linear-gradient(135deg,#0b1220 0%, #0e172a 100%); border:1px solid rgba(255,255,255,.08)}
  .grad-head{position:sticky;top:0;z-index:5;background:rgba(2,6,23,.95);backdrop-filter:blur(6px);padding:.4rem .5rem;border-bottom:1px solid rgba(255,255,255,.1);color:#facc15;text-transform:uppercase;font-weight:700}
  .item{padding:.55rem .65rem;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
  .item:hover{background:rgba(255,255,255,.04)}
  .item.active{background:rgba(250,204,21,.08);border-left:3px solid #facc15}
  .lbl{color:#94a3b8}
  .value{color:#e5e7eb}
  .kv{display:grid;grid-template-columns: 170px 1fr;gap:.5rem .75rem}
  .photo{width:104px;height:140px;border-radius:.75rem;background:#0b1220;border:1px solid rgba(255,255,255,.08);display:grid;place-items:center;color:#94a3b8;overflow:hidden;user-select:none}
  .photo img{width:100%;height:100%;object-fit:cover;display:block}
  .photo .hint{font-size:.75rem;text-align:center;padding:.25rem .4rem;opacity:.8}
  .btn{padding:.5rem .75rem;border:1px solid rgba(255,255,255,.12);border-radius:.65rem;background:transparent}
  .btn:hover{background:rgba(255,255,255,.06)}
  .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.15rem .55rem;border-radius:999px;font-size:.75rem;font-weight:700;letter-spacing:.2px;border:1px solid transparent}
  .chip.green{background:rgba(34,197,94,.15);color:rgb(134,239,172);border-color:rgba(34,197,94,.3)}
  .chip.red{background:rgba(239,68,68,.15);color:rgb(252,165,165);border-color:rgba(239,68,68,.3)}
  select{background-color:#0d1322!important;color:#e5e7eb!important;border:1px solid rgba(255,255,255,.2);border-radius:6px;padding:4px 6px;font-weight:500;appearance:none}
  select option{background-color:#0d1322!important;color:#e5e7eb!important}
  select:focus{outline:2px solid #facc15; outline-offset:1px}
  :root,select,select option{color-scheme:dark}
  @media (max-width: 900px){ .panel{grid-template-columns:1fr} }
  @media print{
    body{background:#fff;color:#000}
    .no-print{display:none!important}
    .card{border:1px solid #000;background:#fff}
    .chip.green,.chip.red{border:1px solid #000;color:#000;background:#fff}
  }
  .dragging { opacity: .5; }
  .drop-target { outline: 2px dashed #facc15; outline-offset: 2px; }
  .sec-actions button{
    padding:.25rem .45rem; border-radius:.4rem;
    border:1px solid rgba(248,113,113,.4); color:#fecaca;
    background:transparent; font-size:.7rem; font-weight:700;
  }
  .sec-actions button:hover{ background:rgba(248,113,113,.15); border-color:rgba(248,113,113,.7); color:#fecaca; }
  .login-overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:60; }
  .login-card{ background:#071029; border:1px solid rgba(255,255,255,.06); padding:1.25rem; border-radius:.75rem; width:320px; color:#e6eef8 }
  .login-card input{ width:100%; padding:.5rem; border-radius:.5rem; border:1px solid rgba(255,255,255,.08); background:#021026; color:#e6eef8 }
  .auth-indicator{ font-size:.85rem; color:#94a3b8; margin-left:.5rem; }
</style>
</head>
<body class="dark text-slate-100">
<div class="max-w-7xl mx-auto px-4 py-6">
  <header class="mb-4 flex items-center gap-3 no-print">
    <div class="h-10 w-10 rounded-lg grid place-items-center font-black border border-amber-500/40 bg-slate-900/60">R</div>
    <div>
      <h1 class="text-xl font-bold">Carteirinhas do Batalhão — RP</h1>
      <p class="text-sm text-slate-400">Selecione um policial à esquerda para ver a carteirinha</p>
    </div>
    <div class="ml-auto flex flex-wrap items-center gap-2">
      <input id="q" class="w-64 px-3 py-2 rounded-lg border border-white/10 bg-slate-900/60" placeholder="Buscar por nome, matrícula, patente..." />
      <div id="editableControls" class="flex items-center gap-2 no-print" style="display:none">
        <button id="btnAdd" class="btn text-xs">+ Adicionar</button>
        <button id="btnAddSection" class="btn text-xs">+ Seção</button>
        <button id="btnSaveJSON" class="btn text-xs">Baixar JSON</button>
        <label class="btn text-xs cursor-pointer">Carregar JSON<input id="inJSON" type="file" accept="application/json" class="hidden"></label>
        <label class="btn text-xs cursor-pointer">Importar CSV<input id="inCSV" type="file" accept=".csv,text/csv" class="hidden"></label>
        <button id="btnSaveCSV" class="btn text-xs">Baixar CSV</button>
      </div>
      <div id="publicControls" class="flex items-center gap-2">
        <button id="btnSaveJSON_public" class="btn text-xs">Baixar JSON (público)</button>
        <button id="btnSaveCSV_public" class="btn text-xs">Baixar CSV (público)</button>
      </div>
      <div id="authControls" class="flex items-center gap-2">
        <button id="btnLogin" class="btn text-xs">Entrar (modo edição)</button>
        <button id="btnLogout" class="btn text-xs" style="display:none">Sair (visualização)</button>
        <span id="authState" class="auth-indicator">Modo: <strong id="authMode">Público</strong></span>
      </div>
    </div>
  </header>

  <div class="panel">
    <aside class="rounded-2xl border border-white/10 bg-slate-900/40 shadow-xl scroll" id="listPane" style="max-height: calc(100vh - 160px)"></aside>
    <main class="card rounded-2xl p-5 shadow-xl border" id="cardPane">
      <div class="text-slate-400">Selecione um policial na lista ao lado…</div>
    </main>
  </div>
</div>

<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-card">
    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="text-lg font-bold">Entrar (edição)</div>
        <div class="text-sm text-slate-400">Digite a senha para habilitar edição</div>
      </div>
      <div><button id="closeLogin" class="btn">Fechar</button></div>
    </div>
    <div class="mb-3">
      <input id="pwInput" type="password" placeholder="Senha" />
    </div>
    <div class="flex gap-2">
      <button id="tryLogin" class="btn w-full">Entrar</button>
    </div>
    <div id="loginMsg" class="text-sm mt-3 text-red-400" style="display:none"></div>
  </div>
</div>

<script>
/* ========= CONFIG SUPABASE ========= */
const SUPABASE_URL = "https://ilonwkgtdszmpcjwlezc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsb253a2d0ZHN6bXBjandsZXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NzQxMDIsImV4cCI6MjA3NTU1MDEwMn0.Cc-BtnHlXaGVCY6T6iXe0QA1tsfc17aX8lswEICvtw0";
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const TABLE = "carteirinhas_data";
const ROW_ID = 1; // linha única compartilhada

/* ========= AUTENTICAÇÃO (client-side) ========= */
// Senha: TropaDoBezerra2025
const STORED_PW_HASH = "d69c7dc7fe40c59c9a2b13810e7a32d2c0d41877c85666d267ff2dfcec4f28ac";

let isAuthenticated = false;

const loginOverlay = document.getElementById('loginOverlay');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const authModeEl = document.getElementById('authMode');
const editableControls = document.getElementById('editableControls');
const btnSaveJSON_public = document.getElementById('btnSaveJSON_public');
const btnSaveCSV_public = document.getElementById('btnSaveCSV_public');

btnLogin.addEventListener('click', ()=> { 
  loginOverlay.style.display='flex'; 
  document.getElementById('pwInput').value=''; 
  document.getElementById('loginMsg').style.display='none'; 
});
document.getElementById('closeLogin').addEventListener('click', ()=> loginOverlay.style.display='none');
document.getElementById('tryLogin').addEventListener('click', tryLogin);
btnLogout.addEventListener('click', ()=> { doLogout(); });

async function sha256hex(str){
  if (!(window.crypto && crypto.subtle)) {
    alert("Seu navegador/ambiente não suporta WebCrypto (SHA-256).");
    return "";
  }
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function tryLogin(){
  const pw = document.getElementById('pwInput').value || "";
  const h = await sha256hex(pw);
  if(h && h === STORED_PW_HASH){
    isAuthenticated = true;
    sessionStorage.setItem('rp.auth', '1');
    loginOverlay.style.display='none';
    applyAuthUI();
  }else{
    const m = document.getElementById('loginMsg'); m.textContent="Senha incorreta."; m.style.display='block';
  }
}
function doLogout(){
  isAuthenticated = false;
  sessionStorage.removeItem('rp.auth');
  applyAuthUI();
}
function applyAuthUI(){
  const auth = sessionStorage.getItem('rp.auth') === '1';
  isAuthenticated = !!auth;
  if(isAuthenticated){
    editableControls.style.display = "flex";
    btnLogin.style.display = "none";
    btnLogout.style.display = "inline-block";
    authModeEl.textContent = "Edição";
  }else{
    editableControls.style.display = "none";
    btnLogin.style.display = "inline-block";
    btnLogout.style.display = "none";
    authModeEl.textContent = "Público";
  }
  renderList(document.getElementById('q').value);
  renderCard();
}

/* ========= CAMPOS ========= */
const COLUMNS = [
  { key:"matricula",       label:"Matrícula",             type:"text" },
  { key:"nome",            label:"Nome",                  type:"text" },
  { key:"guerra",          label:"Nome de Guerra",        type:"text" },
  { key:"patente",         label:"Patente",               type:"select", options:[
      "CEL PM","TEN.CEL PM","MAJ PM","CAP PM","1º TEN PM","2º TEN PM","ASP OF PM",
      "SUBTEN PM","1º SGT PM","2º SGT PM","3º SGT PM","CB PM","SD PM","ALUNO"
    ]},
  { key:"funcao",          label:"Função",                type:"text", multiline:true },
  { key:"edital",          label:"Edital",                type:"text" },
  { key:"situacao",        label:"Situação",              type:"select", options:["ATIVO","Afastado","Férias","Afastamento Médico","Punição","Reserva"] },
  { key:"licenca_premium", label:"Licença Premium",       type:"flag", trueLabel:"ATIVA", falseLabel:"INATIVA" },
  { key:"ultima_promocao", label:"Última Promoção",       type:"date" },
  { key:"turma",           label:"Turma",                 type:"text" },
  { key:"cia",             label:"CIA",                   type:"text" },
  { key:"data_entrada",    label:"Data de Entrada",       type:"date" },
  { key:"padrinhos",       label:"Padrinhos",             type:"text", multiline:true },
  { key:"pad",             label:"PAD",                   type:"text" },
  { key:"foto",            label:"Foto",                  type:"image" },
];

/* ========= ORDENAÇÃO ========= */
const RANK_WEIGHT = {
  "CEL PM":100, "TEN.CEL PM":90, "MAJ PM":80, "CAP PM":70,
  "1º TEN PM":60, "2º TEN PM":50, "ASP OF PM":40,
  "SUBTEN PM":35, "1º SGT PM":34, "2º SGT PM":33, "3º SGT PM":32,
  "CB PM":20, "SD PM":10, "ALUNO":1
};
const GRAD_ORDER = [
  { label:"Oficiais Superiores",    match: p => /(^CEL\b|TEN\.?CEL|MAJ)/i.test(p) },
  { label:"Oficiais Intermediários",match: p => /\bCAP\b/i.test(p) },
  { label:"Oficiais Subalternos",   match: p => /(1º\s*TEN|2º\s*TEN|ASP)/i.test(p) },
  { label:"Praças Graduados",       match: p => /(SUBTEN|SGT|CB|SD)/i.test(p) },
  { label:"Outros",                 match: p => true },
];
function patenteToGraduacao(p=""){
  const up = String(p||"").toUpperCase();
  return (GRAD_ORDER.find(g=>g.match(up))||GRAD_ORDER[GRAD_ORDER.length-1]).label;
}
const rankVal = p => RANK_WEIGHT[p?.toUpperCase?.()] ?? 0;

/* ========= DADOS INICIAIS ========= */
const INITIAL = [
  { matricula:"2410202230", nome:"Matheus Bezerra", guerra:"Bezerra", patente:"TEN.CEL PM",
    funcao:"COMANDANTE AGUIAR / COMANDANTE SINDICÂNCIA / COMANDANTE CCOMSOC",
    edital:"", situacao:"ATIVO", licenca_premium:true, ultima_promocao:"2024-08-01",
    turma:"", cia:"", data_entrada:"2022-03-01", padrinhos:"-", pad:"0/3", foto:"" },
  { matricula:"1042022255", nome:"Davi Costa", guerra:"Rivotril", patente:"MAJ PM",
    funcao:"SUBCOMANDANTE AGUIAR / SUPERVISOR SINDICÂNCIAS / SUPERVISOR CCOMSOC",
    edital:"", situacao:"ATIVO", licenca_premium:false, ultima_promocao:"2024-06-10",
    turma:"", cia:"", data_entrada:"2022-04-01", padrinhos:"-", pad:"0/3", foto:"" },
  { matricula:"1072023259", nome:"Saléh Matias", guerra:"Tranca Rua", patente:"CAP PM",
    funcao:"COMANDANTE 1ª CIA / COMANDO DECIC / COMANDANTE P1 / COMANDANTE P4",
    edital:"", situacao:"ATIVO", licenca_premium:true, ultima_promocao:"2025-01-12",
    turma:"", cia:"CMT. 1ª CIA", data_entrada:"2023-07-01", padrinhos:"-", pad:"0/3", foto:"" },
];

let ROWS = [];             // carregadas do Supabase
let selectedIndex = -1;
const listPane = document.getElementById('listPane');
const cardPane = document.getElementById('cardPane');
const qEl = document.getElementById('q');

/* ========= SINCRONIZAÇÃO REMOTA (Supabase) ========= */
async function fetchRemote(){
  // tenta ler id=1; se não existir, cria com INITIAL
  let { data, error } = await sb.from(TABLE).select("rows").eq("id", ROW_ID).single();
  if (error && error.code === 'PGRST116') { // not found
    await sb.from(TABLE).upsert({ id: ROW_ID, rows: INITIAL });
    ROWS = INITIAL.slice();
    return;
  }
  if (error) {
    console.error("Erro ao carregar Supabase:", error);
    ROWS = INITIAL.slice(); // fallback
    return;
  }
  ROWS = Array.isArray(data?.rows) ? data.rows : INITIAL.slice();
}

let saveTimer = null;
function persistLocal(){ localStorage.setItem('rp.carteirinhas', JSON.stringify(ROWS)); }
function scheduleSave(){
  if(!isAuthenticated) return; // somente no modo edição
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveRemote, 400);
}
async function saveRemote(){
  const { error } = await sb.from(TABLE).update({ rows: ROWS }).eq("id", ROW_ID);
  if (error) console.error("Erro ao salvar no Supabase:", error);
}

/* ========= LISTA ========= */
let dragIndex = null;

function renderList(q=""){
  listPane.innerHTML = "";
  const normQ = norm(q);
  const hasCustomSections = ROWS.some(r=>r.type==="section");

  if (hasCustomSections) {
    ROWS.forEach((entry, i) => {
      if (entry.type==="section") {
        const head = document.createElement('div');
        head.className="grad-head flex items-center justify-between";
        head.innerHTML = `
          <span>${entry.title || "SEÇÃO"}</span>
          ${isAuthenticated ? `<span class="sec-actions">
            <button class="btn-sec-del" title="Excluir seção">Excluir</button>
          </span>` : ""}
        `;
        if(isAuthenticated) head.querySelector('.btn-sec-del').addEventListener('click', (ev)=>{
          ev.stopPropagation();
          if(confirm(`Excluir a seção "${entry.title||'SEÇÃO'}"?`)){
            ROWS.splice(i,1); persistLocal(); scheduleSave(); renderList(qEl.value);
          }
        });
        head.dataset.sectionIndex = i;
        if(isAuthenticated){
          head.addEventListener('dragover', e => { e.preventDefault(); head.classList.add('drop-target'); });
          head.addEventListener('dragleave', () => head.classList.remove('drop-target'));
          head.addEventListener('drop', e => {
            e.preventDefault();
            head.classList.remove('drop-target');
            if (dragIndex===null) return;
            moveItemToSection(dragIndex, i); dragIndex=null;
          });
        }
        listPane.appendChild(head);
        return;
      }
      if (normQ && !COLUMNS.some(c=>norm(entry[c.key]).includes(normQ))) return;
      const item = document.createElement('div');
      item.className = "item";
      if(i===selectedIndex) item.classList.add('active');
      if(isAuthenticated){
        item.draggable = true;
        item.addEventListener('dragstart', () => { dragIndex = i; item.classList.add('dragging'); });
        item.addEventListener('dragend',   () => { item.classList.remove('dragging'); dragIndex = null; });
      }
      item.innerHTML = `
        <div class="font-semibold">${entry.nome||"-"} <span class="text-xs text-slate-400">(${entry.guerra||"-"})</span></div>
        <div class="text-xs text-slate-400">${entry.matricula||"-"} • ${entry.patente||"-"}</div>
      `;
      item.addEventListener('click',()=>{ selectedIndex=i; renderList(qEl.value); renderCard(); });
      listPane.appendChild(item);
    });
    if(!listPane.children.length){
      const none=document.createElement('div');
      none.className="text-slate-400 p-3"; none.textContent="Nenhum registro na seção.";
      listPane.appendChild(none);
    }
    return;
  }

  const groups = {};
  ROWS.forEach((r,i)=>{
    if (r.type==="section") return;
    if (normQ && !COLUMNS.some(c=>norm(r[c.key]).includes(normQ))) return;
    const g = patenteToGraduacao(r.patente);
    (groups[g] ||= []).push({r,i});
  });

  GRAD_ORDER.forEach(g=>{
    const arr = groups[g.label];
    if(!arr || !arr.length) return;
    const head = document.createElement('div');
    head.className = "grad-head";
    head.textContent = g.label;
    listPane.appendChild(head);

    arr.sort((a,b)=>{
      const rw = rankVal(b.r.patente) - rankVal(a.r.patente);
      if (rw!==0) return rw;
      return norm(a.r.nome) < norm(b.r.nome) ? -1 : 1;
    });

    arr.forEach(({r,i})=>{
      const item = document.createElement('div');
      item.className = "item";
      if(i===selectedIndex) item.classList.add('active');
      item.innerHTML = `
        <div class="font-semibold">${r.nome||"-"} <span class="text-xs text-slate-400">(${r.guerra||"-"})</span></div>
        <div class="text-xs text-slate-400">${r.matricula||"-"} • ${r.patente||"-"}</div>
      `;
      item.addEventListener('click',()=>{ selectedIndex=i; renderList(qEl.value); renderCard(); });
      listPane.appendChild(item);
    });
  });

  if(!listPane.children.length){
    const empty=document.createElement('div');
    empty.className="text-slate-400 p-3";
    empty.textContent="Nenhum registro encontrado.";
    listPane.appendChild(empty);
  }
}

function moveItemToSection(itemIndex, sectionIndex){
  if(itemIndex===sectionIndex) return;
  const [item] = ROWS.splice(itemIndex,1);
  let dest = sectionIndex;
  if(itemIndex < sectionIndex) dest = sectionIndex - 1;
  const insertAt = dest + 1;
  ROWS.splice(insertAt, 0, item);
  persistLocal(); scheduleSave(); renderList(qEl.value); renderCard();
}

/* ========= CARTEIRINHA ========= */
function renderCard(){
  cardPane.innerHTML = "";
  if(selectedIndex<0 || !ROWS[selectedIndex] || ROWS[selectedIndex].type==="section"){
    cardPane.innerHTML = `<div class="text-slate-400">Selecione um policial na lista ao lado…</div>`;
    return;
  }
  const p = ROWS[selectedIndex];

  const header = document.createElement('div');
  header.className = "flex items-start gap-4 mb-4";
  header.innerHTML = `
    <div class="photo select-none" id="photoBox">
      ${p.foto ? `<img src="${p.foto}" alt="Foto">` : `<div class="hint">Foto<br>clique/arraste/Ctrl+V</div>`}
    </div>
    <div class="flex-1">
      <div class="text-2xl font-extrabold">${p.nome||"-"} <span class="text-slate-400 text-lg">(${p.guerra||"-"})</span></div>
      <div class="text-slate-300">${p.patente||"-"} • ${patenteToGraduacao(p.patente)}</div>
      <div class="mt-2 flex flex-wrap gap-2">
        ${p.licenca_premium ? `<span class="chip green">Licença Premium ATIVA</span>` : `<span class="chip red">Licença Premium INATIVA</span>`}
        ${p.situacao?`<span class="chip" style="background:rgba(59,130,246,.18);color:#93c5fd;border-color:rgba(59,130,246,.35)">Situação: ${p.situacao}</span>`:""}
      </div>
    </div>
    <div class="no-print flex flex-col gap-2">
      ${isAuthenticated ? `<button id="btnEdit" class="btn text-xs">Editar</button>
      <button id="btnPrint" class="btn text-xs">Imprimir</button>
      <button id="btnDelete" class="btn text-xs text-red-300">Excluir</button>` :
      `<button id="btnPrint" class="btn text-xs">Imprimir</button>`}
    </div>
  `;
  cardPane.appendChild(header);

  const photoBox = header.querySelector('#photoBox');
  if(isAuthenticated){
    photoBox.addEventListener('click', ()=> openImagePicker(setPhotoFromFile));
    photoBox.addEventListener('dragover', (e)=>{ e.preventDefault(); photoBox.style.outline='2px dashed #facc15'; });
    photoBox.addEventListener('dragleave', ()=>{ photoBox.style.outline='none'; });
    photoBox.addEventListener('drop', (e)=>{
      e.preventDefault(); photoBox.style.outline='none';
      const f = [...e.dataTransfer.files||[]].find(f=>f.type.startsWith('image/'));
      if(f) setPhotoFromFile(f);
    });
    cardPane.onpaste = (e)=>{
      const item = [...e.clipboardData.items].find(i=>i.type.startsWith('image/'));
      if(item){ setPhotoFromFile(item.getAsFile()); }
    };
  } else {
    photoBox.style.cursor = 'default';
    cardPane.onpaste = null;
  }

  const grid = document.createElement('div');
  grid.className = "kv";
  grid.innerHTML = `
    ${field("Matrícula","matricula",p.matricula)}
    ${field("Nome","nome",p.nome)}
    ${field("Nome de Guerra","guerra",p.guerra)}
    ${field("Patente","patente",p.patente,true)}
    ${field("Edital","edital",p.edital)}
    ${field("Turma","turma",p.turma)}
    ${field("CIA","cia",p.cia)}
    ${field("Data de Entrada","data_entrada",p.data_entrada,false,"date")}
    ${field("Última Promoção","ultima_promocao",p.ultima_promocao,false,"date")}
    ${flagField("Licença Premium","licenca_premium",p.licenca_premium)}
    ${field("Situação","situacao",p.situacao,true, "select-situacao")}
    ${longField("Função","funcao",p.funcao)}
    ${longField("Padrinhos","padrinhos",p.padrinhos)}
    ${field("PAD","pad",p.pad)}
  `;
  cardPane.appendChild(grid);

  document.getElementById('btnPrint').onclick = () => window.print();
  if(isAuthenticated){
    document.getElementById('btnDelete').onclick = () => {
      if(confirm("Remover este registro?")){
        ROWS.splice(selectedIndex,1);
        selectedIndex = -1; persistLocal(); scheduleSave(); renderList(qEl.value); renderCard();
      }
    };
    document.getElementById('btnEdit').onclick = () => toggleEdit(true);
  }

  function toggleEdit(on){
    if(!isAuthenticated) return alert("Somente usuários autenticados podem editar.");
    const nodes = cardPane.querySelectorAll('[data-key]');
    nodes.forEach(node=>{
      const key = node.dataset.key;
      const col = COLUMNS.find(c=>c.key===key);
      const current = p[key] ?? "";

      if(col?.type==="flag"){
        const btn = document.createElement('button');
        btn.className = "btn text-xs";
        btn.textContent = p[key] ? "Desativar Premium" : "Ativar Premium";
        btn.onclick = ()=>{ p[key]=!p[key]; persistLocal(); scheduleSave(); renderCard(); };
        node.replaceChildren(btn);
        return;
      }
      if(col?.type==="select"){
        const sel = document.createElement('select');
        sel.className="bg-transparent border border-white/10 rounded-md px-2 py-1 text-sm";
        (col.options||[]).forEach(opt=>{
          const o=document.createElement('option'); o.value=opt; o.textContent=opt; if(opt===current) o.selected=true; sel.appendChild(o);
        });
        sel.onchange=()=>{ p[key]=sel.value; persistLocal(); scheduleSave(); };
        node.replaceChildren(sel);
        return;
      }
      if(col?.type==="date"){
        const inp=document.createElement('input'); inp.type="date";
        inp.className="bg-transparent border border-white/10 rounded-md px-2 py-1 text-sm";
        if(current) inp.value=String(current).slice(0,10);
        inp.onchange=()=>{ p[key]=inp.value; persistLocal(); scheduleSave(); };
        node.replaceChildren(inp);
        return;
      }
      const ed = document.createElement(col?.multiline?'textarea':'input');
      if(col?.multiline){ ed.rows = 3; }
      ed.className="bg-transparent border border-white/10 rounded-md px-2 py-1 text-sm w-full";
      ed.value = current;
      ed.onblur=()=>{ p[key]=ed.value.trim(); persistLocal(); scheduleSave(); renderCard(); };
      node.replaceChildren(ed);
    });

    const tools = document.createElement('div');
    tools.className="no-print flex gap-2 mt-2";
    tools.innerHTML = `
      <button class="btn text-xs" id="btnChangePhoto">Trocar foto</button>
      ${p.foto ? `<button class="btn text-xs" id="btnRemovePhoto">Remover</button>` : ``}
    `;
    header.appendChild(tools);
    tools.querySelector('#btnChangePhoto').onclick = ()=> openImagePicker(setPhotoFromFile);
    const rm = tools.querySelector('#btnRemovePhoto');
    if(rm) rm.onclick = ()=>{ p.foto=""; persistLocal(); scheduleSave(); renderCard(); };

    const b = document.getElementById('btnEdit');
    b.textContent = "Concluir";
    b.onclick = ()=> renderCard();
  }

  function field(label,key,value,asSelect=false, mode="text"){
    return `
      <div class="lbl">${label}</div>
      <div class="value" data-key="${key}">
        ${mode==="date" ? (value?formatDate(value):"-")
          : mode==="select-situacao" ? (value||"-")
          : (value||"-")}
      </div>
    `;
  }
  function flagField(label,key,value){
    return `
      <div class="lbl">${label}</div>
      <div class="value" data-key="${key}">
        ${value ? `<span class="chip green">ATIVA</span>` : `<span class="chip red">INATIVA</span>`}
      </div>
    `;
  }
  function longField(label,key,value){
    return `
      <div class="lbl">${label}</div>
      <div class="value" data-key="${key}">
        <div class="whitespace-pre-wrap leading-relaxed">${(value||"-")}</div>
      </div>
    `;
  }

  function openImagePicker(cb){
    const input = document.createElement('input');
    input.type='file'; input.accept='image/*';
    input.onchange = ()=>{ const f=input.files?.[0]; if(f) cb(f); };
    input.click();
  }
  function setPhotoFromFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async ()=> {
      const resized = await resizeDataURL(reader.result, 420);
      p.foto = resized; persistLocal(); scheduleSave(); renderCard();
    };
    reader.readAsDataURL(file);
  }
}

/* ========= BUSCA ========= */
qEl.addEventListener('input', ()=> renderList(qEl.value));

/* ========= CONTROLES ========= */
document.getElementById('btnAdd')?.addEventListener('click', ()=>{
  if(!isAuthenticated) return alert("Somente usuários autenticados podem adicionar.");
  const novo = Object.fromEntries(COLUMNS.map(c=>[c.key,""]));
  novo.patente = "CB PM";
  ROWS.push(novo);
  selectedIndex = ROWS.length-1;
  persistLocal(); scheduleSave(); renderList(qEl.value); renderCard();
});
document.getElementById('btnAddSection')?.addEventListener('click', ()=>{
  if(!isAuthenticated) return alert("Somente usuários autenticados podem criar seções.");
  const t = prompt("Título da seção:", "NOVA SEÇÃO");
  ROWS.push({ type:"section", title: (t||"NOVA SEÇÃO").trim() });
  persistLocal(); scheduleSave(); renderList(qEl.value);
});
document.getElementById('btnSaveJSON')?.addEventListener('click', ()=>{
  if(!isAuthenticated) return alert("Somente usuários autenticados podem exportar JSON (com todas as seções).");
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(ROWS,null,2)],{type:'application/json'}));
  a.download = "policiais.json"; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('inJSON')?.addEventListener('change', (e)=>{
  if(!isAuthenticated) return alert("Somente usuários autenticados podem importar JSON.");
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{
    try{ ROWS = JSON.parse(r.result); selectedIndex=-1; persistLocal(); scheduleSave(); renderList(qEl.value); renderCard(); }
    catch{ alert("JSON inválido"); }
  }; r.readAsText(f);
});
document.getElementById('inCSV')?.addEventListener('change', (e)=>{
  if(!isAuthenticated) return alert("Somente usuários autenticados podem importar CSV.");
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{
    const data = parseCSV(r.result); const [hdr,...lines]=data;
    const map = hdr.map(h=>{
      const n = norm(h);
      return COLUMNS.find(c=>norm(c.label)===n || norm(c.key)===n)?.key || null;
    });
    const rows=[];
    lines.forEach(cells=>{
      if(cells.every(c=>!String(c||"").trim())) return;
      const obj = {};
      map.forEach((k,i)=>{
        if(!k) return;
        const col=COLUMNS.find(c=>c.key===k);
        let v = cells[i];
        if(col?.type==='flag'){
          const nv=norm(v); obj[k]=(nv==='true'||nv==='verdadeiro'||nv==='sim'||nv==='ativa'||nv==='ok');
        }else if(col?.type==='date'){
          const d = new Date(v); obj[k]=isFinite(d)?d.toISOString().slice(0,10):"";
        }else{
          obj[k]=v;
        }
      });
      rows.push(obj);
    });
    ROWS = rows; selectedIndex=-1; persistLocal(); scheduleSave(); renderList(qEl.value); renderCard();
  }; r.readAsText(f);
});
document.getElementById('btnSaveCSV')?.addEventListener('click', ()=>{
  if(!isAuthenticated) return alert("Somente usuários autenticados podem exportar CSV (com todas as seções).");
  const rows = [];
  rows.push(COLUMNS.map(c=>c.label));
  ROWS.forEach(r=>{
    if(r.type==="section") return;
    rows.push(COLUMNS.map(col=>{
      if(col.key==='foto') return "";
      let v = r[col.key] ?? "";
      if(col.type==='flag') v = (v ? (col.trueLabel||'SIM') : (col.falseLabel||'NÃO'));
      return v;
    }));
  });
  const esc=s=>/[",\n]/.test(String(s))?`"${String(s).replace(/"/g,'""')}"`:String(s);
  const csv = rows.map(r=>r.map(esc).join(",")).join("\n");
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
  a.download="policiais.csv"; a.click(); URL.revokeObjectURL(a.href);
});

btnSaveJSON_public.addEventListener('click', ()=>{
  const rows = ROWS.filter(r=>r.type!=="section");
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(rows,null,2)],{type:'application/json'}));
  a.download = "policiais_publico.json"; a.click(); URL.revokeObjectURL(a.href);
});
btnSaveCSV_public.addEventListener('click', ()=>{
  const rows = [];
  rows.push(COLUMNS.filter(c=>c.key!=='foto').map(c=>c.label));
  ROWS.forEach(r=>{
    if(r.type==="section") return;
    rows.push(COLUMNS.filter(c=>c.key!=='foto').map(col=>{
      let v = r[col.key] ?? "";
      if(col.type==='flag') v = (v ? (col.trueLabel||'SIM') : (col.falseLabel||'NÃO'));
      return v;
    }));
  });
  const esc=s=>/[",\n]/.test(String(s))?`"${String(s).replace(/"/g,'""')}"`:String(s);
  const csv = rows.map(r=>r.map(esc).join(",")).join("\n");
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
  a.download="policiais_publico.csv"; a.click(); URL.revokeObjectURL(a.href);
});

/* ========= UTILS ========= */
function formatDate(v){
  const s=String(v); const d = new Date(s);
  if(!isFinite(d)) return s||"-";
  return d.toISOString().slice(0,10).split("-").reverse().join("/");
}
function norm(s){
  return String(s||"")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();
}
function parseCSV(txt){
  const rows=[];let i=0,f='',row=[],q=false;
  while(i<txt.length){const c=txt[i];
    if(q){ if(c=='"'){ if(txt[i+1]=='"'){f+='"';i++;} else q=false; } else f+=c; }
    else{ if(c=='"') q=true; else if(c==','){ row.push(f); f=''; }
      else if(c=='\n'||c=='\r'){ if(f.length||row.length){ row.push(f); rows.push(row); row=[]; f=''; } if(c=='\r'&&txt[i+1]=='\n') i++; }
      else f+=c; }
    i++;
  }
  if(f.length||row.length){ row.push(f); rows.push(row); }
  return rows;
}
function resizeDataURL(dataUrl, maxW=420){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', 0.9));
    };
    img.src=dataUrl;
  });
}

/* ========= BOOT ROBUSTO ========= */
window.addEventListener('error', (e) => {
  console.error(e?.error || e);
  const pane = document.getElementById('cardPane');
  if (pane) pane.innerHTML = `<div class="text-red-300">Erro ao iniciar: ${String(e.message||e).replace(/</g,'&lt;')}</div>`;
});
async function boot() {
  applyAuthUI(); // aplica modo salvo antes de renderizar
  try {
    await fetchRemote();
  } catch (err) {
    console.error("Falha no fetch remoto:", err);
    ROWS = INITIAL.slice();
  }
  renderList("");  // primeira renderização com dados remotos
  renderCard();
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', boot, { once: true });
} else {
  boot();
}
</script>
</body>
</html>
